var Infinitum=function(){function b(a,c){this.defaults={debug:!1,load:null,map:{},template:"#item-template",templateRenderer:void 0,container:"body",contentClass:"",spinnerClass:"loader",messageClass:"message",sourceAttr:"data-load",dataPath:"data",nextPagePath:"next_page",totalPagesPath:"total_pages",offset:0,endMessage:"No more items to load...",animation:null,waitForImages:!1};void 0===c&&(c=a,a=c.map);this.options=$.extend({},this.defaults,c);this.map=a;this.template=this.getTemplateContent();
    this.container=this.getContainer();this.bindEvents();this.init()}b.prototype.init=function(){var a=this.options;this.content=this.insertContent();this.spinner=this.insertSpinner();this.message=this.insertMessage();this.scrollHelper=this.insertScrollHelper();this.nextPage=a.load?a.load:this.parseSource();this.page=this.totalPages=0;this.loading=!1;this.canLoad=!0;this.toReload=!1;this.check()};b.prototype.bindEvents=function(){$(window).on("scroll",this.check.bind(this));this.container.on("infinitum:scrolled-in",
    this.onScrolledIn.bind(this));this.container.on("infinitum:reload",this.onReload.bind(this));this.container.on("infinitum:loaded",this.onLoaded.bind(this));this.container.on("infinitum:end",this.onEnd.bind(this))};b.prototype.getContainer=function(){return $(this.options.container)};b.prototype.parseSource=function(){return this.container.attr(this.options.sourceAttr)};b.prototype.insertContent=function(){var a=$("<div>");a.addClass(this.options.contentClass);this.container.append(a);return a};b.prototype.insertScrollHelper=
    function(){var a=$("<div>");this.container.append(a);return a};b.prototype.insertSpinner=function(){var a=$("<div>");a.addClass(this.options.spinnerClass);a.hide();this.container.append(a);return a};b.prototype.insertMessage=function(){var a=$("<div>");a.addClass(this.options.messageClass);a.hide();this.container.append(a);return a};b.prototype.check=function(){if(this.canLoad){var a=this.isInView(this.scrollHelper);!this.loading&&a&&this.container.trigger("infinitum:scrolled-in")}};b.prototype.isInView=
    function(a){a=a.offset().top;var c=$(window).height(),b=$(window).scrollTop();return 0<a-b&&a-b<c-this.options.offset};b.prototype.load=function(){this.loading=!0;this.nextPage&&void 0!==this.nextPage||this.container.trigger("infinitum:end");$.ajax({url:this.nextPage,dataType:"json",success:function(a){this.renderResponse(a);this.parseNextPage(a);this.parseTotalPages(a);this.container.trigger("infinitum:loaded")}.bind(this),error:function(a){this.showMessage("Error: ("+a.status+") "+a.statusText)}.bind(this)})};
    b.prototype.renderResponse=function(a){a=this.parseResponse(a);if(void 0===a)this.showMessage("Response cannot be parsed");else if(Array.isArray(a))try{this.render(a)}catch(c){this.showMessage(c)}else this.showMessage("Response data must be an array")};b.prototype.parseResponse=function(a){return this.getProperty(a,this.options.dataPath)};b.prototype.parseData=function(a){var c=this,b={};this.placeholderNames.forEach(function(d){var f=c.map[d];if(void 0===f)throw"Map is missing a property that is defined in the template";
        b[d]=c.getProperty(a,f)});return b};b.prototype.parseNextPage=function(a){this.nextPage=this.getProperty(a,this.options.nextPagePath)};b.prototype.parseTotalPages=function(a){0===this.totalPages&&(this.totalPages=this.getProperty(a,this.options.totalPagesPath))};b.prototype.onScrolledIn=function(){this.load();this.spinner.show()};b.prototype.onLoaded=function(){this.spinner.hide();this.loading=!1;this.page++;this.page>=this.totalPages&&this.container.trigger("infinitum:end");this.toReload&&this.container.trigger("infinitum:reload")};
    b.prototype.onReload=function(){this.loading?this.toReload=!0:(this.container.empty(),this.init())};b.prototype.onEnd=function(){this.showMessage(this.options.endMessage)};b.prototype.render=function(a){var b=this;this.getPlaceholderNames();a.forEach(function(a){var d=a;try{void 0===b.options.templateRenderer&&(d=b.parseData(a))}catch(f){throw"Cannot render template: "+f;}a=b.renderTemplate(d);a=b.appendItem(a);b.animate(a)})};b.prototype.animate=function(a){if(this.options.animation){var b=this.options.animation+
        "-enter";a.addClass(this.options.animation);a.addClass(b);if(this.options.waitForImages)a.find("img").one("load",function(){a.removeClass(b)});else setTimeout(function(){a.removeClass(b)},0)}};b.prototype.appendItem=function(a){return $(a).appendTo(this.content)};b.prototype.getTemplateContent=function(){var a=$(this.options.template),b=a.html();a.remove();return b};b.prototype.renderTemplate=function(a){var b=this.template;this.options.templateRenderer?b=this.options.templateRenderer(this.template,
        a):placeholderNames.forEach(function(e){b=b.replace(new RegExp("{{ *"+e+" *}}","g"),a[e])});return b};b.prototype.getPlaceholderNames=function(){for(var a=[],b=/{{ *([a-zA-Z0-9_]+) *}}/g,e=b.exec(this.template);null!=e;)a.push(e[1]),e=b.exec(this.template);return a};b.prototype.showMessage=function(a){this.options.debug?this.message.text(a):this.message.text(this.options.endMessage);this.message.text()&&this.message.show();this.spinner.hide();this.canLoad=!1};b.prototype.getProperty=function(a,b){for(var e=
        b.split("."),d=0,f=e.length;null!=a&&d<f;)a=a[e[d++]];return d&&d==f?a:void 0};return b}();
